<!DOCTYPE html>
<html lang="ja">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reading Journal for Japanese Learners ‚Äì Track Books in Japanese & English</title>

  <!-- Google tag (gtag.js) ‚úÖscript„ÅØÂøÖ„ÅöÈñâ„Åò„Çã -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R1MF9WR97T"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-R1MF9WR97T');
  </script>

  <style>
    body {
      font-family: 'Cormorant Garamond', serif;
      background: #f7f3ed;
      margin: 0;
      padding: 90px;
      color: #2b2b2b;
      font-size: 18px;
      line-height: 1.6;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      text-align: center;
      margin: 0 0 28px;
      font-size: 48px;
      letter-spacing: 4px;
      font-weight: 500;
      color: #5a6675;
    }

    h1::after {
      content: "";
      display: block;
      width: 56px;
      height: 1px;
      background: rgba(200, 162, 168, 0.55);
      margin: 26px auto 0;
    }

    .about-link { text-align: center; margin: 20px 0 30px 0; }

    .hero-sub2{
      text-align:center;
      margin: 8px 0 0;
      font-size:15px;
      color: rgba(90,102,117,0.60);
    }

    .value-bullets{
      max-width:820px;
      margin: 26px auto 0;
      display:flex;
      justify-content:center;
      gap: 18px;
      flex-wrap:wrap;
      color: rgba(90,102,117,0.80);
      font-size:14px;
    }
    .value-bullets div{
      padding: 6px 12px;
      border: 1px solid rgba(90,102,117,0.18);
      border-radius: 999px;
      background: rgba(255,255,255,0.45);
    }

    input[type="text"] {
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid rgba(60, 60, 60, 0.18);
      width: 260px;
      background: rgba(255, 255, 255, 0.6);
      font-family: 'Cormorant Garamond', serif;
      font-size: 18px;
      outline: none;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      border-color: rgba(90, 102, 117, 0.55);
      box-shadow: 0 0 0 3px rgba(90, 102, 117, 0.10);
    }

    input[type="checkbox"] { width: auto; margin: 0; }

    button {
      padding: 7px 16px;
      border-radius: 6px;
      border: 1px solid rgba(90, 102, 117, 0.45);
      background: rgba(90, 102, 117, 0.08);
      color: #4f5a67;
      cursor: pointer;
      transition: all 0.25s ease;
      font-family: 'Cormorant Garamond', serif;
      letter-spacing: 1px;
      font-size: 15px;
      white-space: nowrap;
    }
    button:hover { background: rgba(90, 102, 117, 0.14); }

    .top-bar {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin: 28px 0 20px;
      align-items: center;
    }

    #bookList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 24px;
      margin-top: 40px;
    }

    .cover {
      width: 80px;
      height: 110px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid rgba(60,60,60,0.10);
      background: rgba(255,255,255,0.6);
      flex: 0 0 auto;
      display: block;
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      min-width: 0;
    }

    .title {
      font-weight: 600;
      font-size: 20px;
      letter-spacing: 0.5px;
      line-height: 1.2;
      word-break: break-word;
      cursor: default; /* ‚úÖÁ∑®ÈõÜ„Åó„Å™„ÅÑ */
    }

    .seriesline {
      font-size: 14px;
      color: rgba(90,102,117,0.80);
      letter-spacing: 0.5px;
      font-style: italic;
      margin-top: -4px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .checkset {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .mini-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .mini-row button {
      padding: 4px 10px;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }
    .tag {
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(200, 162, 168, 0.18);
      border: 1px solid rgba(200, 162, 168, 0.45);
      color: #5a6675;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    .tag.active {
      background: rgba(90, 102, 117, 0.20);
      border-color: rgba(90, 102, 117, 0.35);
    }

    /* -------- Modal -------- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(20, 25, 35, 0.35);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 28px;
      z-index: 9999;
    }
    .modal-card {
      width: min(560px, 94vw);
      background: rgba(255, 255, 255, 0.88);
      border: 1px solid rgba(60, 60, 60, 0.12);
      border-radius: 14px;
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.18);
      padding: 18px;
      backdrop-filter: blur(6px);
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      letter-spacing: 1px;
      color: #5a6675;
      margin: 6px 8px 14px;
    }
    .modal-img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(60, 60, 60, 0.10);
      display: block;
    }
    .modal-hint {
      margin: 10px 8px 0;
      font-size: 13px;
      color: rgba(80, 90, 105, 0.75);
    }

    /* ‚úÖ edit modal */
    .modal-label{
      margin: 0 8px 8px;
      font-size: 13px;
      color: rgba(90,102,117,0.75);
      letter-spacing: .3px;
    }
    .edit-input, .edit-textarea{
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      border-radius: 12px;
      border: 1px solid rgba(60,60,60,0.18);
      background: rgba(255,255,255,0.70);
      outline: none;
      padding: 10px 12px;
      font-size: 16px;
    }
    .edit-input:focus, .edit-textarea:focus{
      border-color: rgba(90, 102, 117, 0.55);
      box-shadow: 0 0 0 3px rgba(90, 102, 117, 0.10);
    }
    .edit-textarea{
      min-height: 160px;
      resize: vertical;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      margin-top: 14px;
      padding: 0 4px 2px;
    }
    .btn-ghost{
      background: rgba(90, 102, 117, 0.05);
    }

    /* -------- Card flip -------- */
    .flip-card { perspective: 1200px; }
    .flip-inner {
      display: grid;
      transform-style: preserve-3d;
      transition: transform 0.55s ease;
    }
    .flip-card.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-side {
      grid-area: 1 / 1;
      backface-visibility: hidden;
    }
    .flip-back { transform: rotateY(180deg); }

    .book-surface {
      background: rgba(255, 255, 255, 0.72);
      padding: 34px 36px;
      border-radius: 12px;
      border: 1px solid rgba(60, 60, 60, 0.10);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
      display: flex;
      gap: 25px;
      align-items: flex-start;
      transition: box-shadow 0.25s ease;
      min-height: 320px;
    }
    .flip-card:hover .book-surface {
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.06);
    }
    .book-surface.finished {
      background: rgba(245, 238, 236, 0.75);
      border-left: 2px solid rgba(200, 162, 168, 0.75);
    }

    .side-badge {
      font-size: 12px;
      letter-spacing: 1px;
      color: rgba(90, 102, 117, 0.8);
      border: 1px solid rgba(90, 102, 117, 0.28);
      padding: 2px 10px;
      border-radius: 999px;
      display: inline-block;
      margin-bottom: 6px;
    }

    .note {
      font-size: 15px;
      color: rgba(70, 80, 95, 0.9);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      cursor: default; /* ‚úÖÁ∑®ÈõÜ„Åó„Å™„ÅÑ */
    }
    .note.empty { color: rgba(70, 80, 95, 0.45); }

    /* --- Responsive (mobile) --- */
    @media (max-width: 640px) {
      body { padding: 22px; font-size: 16px; }
      h1 { font-size: 34px; margin-bottom: 18px; }
      .top-bar { gap: 10px; margin: 18px 0 12px; }
      input[type="text"] { width: min(92vw, 360px); }
      #bookList { grid-template-columns: 1fr; gap: 16px; margin-top: 22px; }
      .book-surface { padding: 18px; gap: 14px; min-height: 260px; }
      .cover { width: 70px; height: 96px; }
      .mini-row { gap: 6px; }
      .mini-row button { padding: 6px 10px; font-size: 12px; }
      .edit-textarea{ min-height: 200px; }
    }
  </style>
</head>

<body>
  <h1>The Reading Journal</h1>

  <p class="hero-sub2">
    Flip cards to keep Japanese & English titles, notes, and links separately.
  </p>

  <p class="about-link">
    <a href="portfolio.html">About this project</a>
  </p>

  <div class="value-bullets">
    <div>üìö Manage series & volumes</div>
    <div>üåè Separate JP / EN titles & notes</div>
    <div>üìù Build your own learning log</div>
  </div>

  <div class="top-bar">
    <input
      type="text"
      id="titleInput"
      placeholder="Japanese Title"
      onkeydown="if(event.key === 'Enter') addBook()"
    />
    <button onclick="addBook()">Add</button>
    <input type="text" id="searchInput" placeholder="Search..." oninput="displayBooks()" />
  </div>

  <div id="bookList"></div>
  <input type="file" id="coverFileInput" accept="image/*" style="display:none" />

  <script>
    // ---------------------------
    // Books: localStorage
    // Covers: IndexedDB
    // ---------------------------
    let books = [];
    let activeTag = null;

    function trackEvent(name, params = {}) {
      if (typeof gtag === "function") gtag("event", name, params);
    }

    // ---- localStorage ----
    const savedBooks = localStorage.getItem("books");
    if (savedBooks) books = JSON.parse(savedBooks);

    function saveBooks() {
      localStorage.setItem("books", JSON.stringify(books));
    }

    // ‚úÖ migrate old data -> new fields
    function ensureBookIdsAndDefaults() {
      let changed = false;

      for (const b of books) {
        if (!b.id) {
          b.id = crypto.randomUUID
            ? crypto.randomUUID()
            : String(Date.now()) + Math.random().toString(16).slice(2);
          changed = true;
        }

        if (typeof b.title !== "string") { b.title = ""; changed = true; }
        if (typeof b.jpTitle !== "string") { b.jpTitle = b.title || ""; changed = true; }
        if (typeof b.enTitle !== "string") { b.enTitle = ""; changed = true; }

        if (typeof b.series !== "string") { b.series = ""; changed = true; }
        if (typeof b.volume !== "string") { b.volume = ""; changed = true; }

        if (!Array.isArray(b.tags)) { b.tags = []; changed = true; }

        if (typeof b.jpUrl !== "string") { b.jpUrl = ""; changed = true; }
        if (typeof b.trUrl !== "string") { b.trUrl = ""; changed = true; }
        if (typeof b.jpNote !== "string") { b.jpNote = ""; changed = true; }
        if (typeof b.trNote !== "string") { b.trNote = ""; changed = true; }

        if (typeof b.finished !== "boolean") { b.finished = !!b.finished; changed = true; }
      }

      if (changed) saveBooks();
    }

    // ---- IndexedDB ----
    const DB_NAME = "reading_journal_db";
    const DB_VERSION = 1;
    const STORE = "covers";
    let db = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        if (!("indexedDB" in window)) {
          reject(new Error("IndexedDB is not supported"));
          return;
        }
        const req = indexedDB.open(DB_NAME, DB_VERSION);

        req.onupgradeneeded = (event) => {
          const d = event.target.result;
          if (!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE);
        };
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onerror = () => reject(req.error);
      });
    }

    function putCover(key, blob) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(blob, key);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    function getCover(key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    function deleteCover(key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).delete(key);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    // ---- ObjectURL cache ----
    const coverUrlCache = new Map();
    function revokeCoverUrl(key) {
      const url = coverUrlCache.get(key);
      if (url) {
        URL.revokeObjectURL(url);
        coverUrlCache.delete(key);
      }
    }
    function coverKey(bookId, side) {
      return `${bookId}:${side}`;
    }

    // ---- UI helpers ----
    function createCheckSet(checkbox, text) {
      const wrapper = document.createElement("label");
      wrapper.className = "checkset";
      wrapper.appendChild(checkbox);
      wrapper.appendChild(document.createTextNode(text));
      return wrapper;
    }

    // ‚úÖ cover modal (existing)
    function openCoverModal({ title, src }) {
      const modal = document.createElement("div");
      modal.className = "modal";

      const card = document.createElement("div");
      card.className = "modal-card";

      const t = document.createElement("div");
      t.className = "modal-title";
      t.textContent = title || "Cover";

      const img = document.createElement("img");
      img.className = "modal-img";
      img.src = src;
      img.alt = "cover";

      const hint = document.createElement("div");
      hint.className = "modal-hint";
      hint.textContent = "Click outside or press Esc to close";

      card.appendChild(t);
      card.appendChild(img);
      card.appendChild(hint);
      modal.appendChild(card);
      document.body.appendChild(modal);

      function close() {
        document.removeEventListener("keydown", onKeyDown);
        modal.remove();
      }
      function onKeyDown(e) { if (e.key === "Escape") close(); }

      modal.addEventListener("click", (e) => { if (e.target === modal) close(); });
      document.addEventListener("keydown", onKeyDown);
    }

    // ‚úÖ edit modal (NEW)
    function openEditModal({ title, label, value, multiline = false, placeholder = "", onSave }) {
      const modal = document.createElement("div");
      modal.className = "modal";

      const card = document.createElement("div");
      card.className = "modal-card";

      const t = document.createElement("div");
      t.className = "modal-title";
      t.textContent = title || "Edit";

      const l = document.createElement("div");
      l.className = "modal-label";
      l.textContent = label || "";

      const field = multiline ? document.createElement("textarea") : document.createElement("input");
      if (!multiline) field.type = "text";

      field.className = multiline ? "edit-textarea" : "edit-input";
      field.value = value ?? "";
      field.placeholder = placeholder;

      const actions = document.createElement("div");
      actions.className = "modal-actions";

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn-ghost";
      cancelBtn.textContent = "Cancel";

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";

      actions.appendChild(cancelBtn);
      actions.appendChild(saveBtn);

      const hint = document.createElement("div");
      hint.className = "modal-hint";
      hint.textContent = "Esc to close. (Note: Save is required to apply changes.)";

      card.appendChild(t);
      card.appendChild(l);
      card.appendChild(field);
      card.appendChild(actions);
      card.appendChild(hint);

      modal.appendChild(card);
      document.body.appendChild(modal);

      function close() {
        document.removeEventListener("keydown", onKeyDown);
        modal.remove();
      }

      function save() {
        const v = (field.value ?? "").trim();
        onSave?.(v);
        close();
      }

      function onKeyDown(e) {
        if (e.key === "Escape") close();
        // Ctrl/Cmd+Enter „Åß‰øùÂ≠òÔºànoteÂêë„ÅëÔºâ
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") save();
        // input(title) „ÅÆ Enter „Åß‰øùÂ≠ò
        if (!multiline && e.key === "Enter") save();
      }

      modal.addEventListener("click", (e) => { if (e.target === modal) close(); });
      cancelBtn.addEventListener("click", close);
      saveBtn.addEventListener("click", save);
      document.addEventListener("keydown", onKeyDown);

      // modal ÂÜÖ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂèçËª¢„Å™„Å©„ÇíËµ∑„Åì„Åï„Å™„ÅÑ
      card.addEventListener("click", (e) => e.stopPropagation());

      // focus
      setTimeout(() => {
        field.focus();
        if (!multiline) field.select?.();
      }, 0);
    }

    // ---- App ----
    function addBook() {
      const input = document.getElementById("titleInput");
      const jpTitle = input.value.trim();
      if (!jpTitle) return;

      const id = crypto.randomUUID
        ? crypto.randomUUID()
        : String(Date.now()) + Math.random().toString(16).slice(2);

      books.push({
        id,
        jpTitle,
        enTitle: "",
        title: jpTitle, // legacy
        finished: false,
        jpUrl: "",
        trUrl: "",
        jpNote: "",
        trNote: "",
        series: "",
        volume: "",
        tags: []
      });

      trackEvent("add_book", { jp_title: jpTitle });

      input.value = "";
      input.focus();
      saveBooks();
      displayBooks();
    }

    function numericOrNaN(v) {
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : NaN;
    }

    function sideTitleOf(book, isJP) {
      const jp = (book.jpTitle || "").trim();
      const en = (book.enTitle || "").trim();
      const legacy = (book.title || "").trim();
      if (isJP) return jp || legacy || "";
      return en || "";
    }

    async function displayBooks() {
      const list = document.getElementById("bookList");
      list.innerHTML = "";

      const searchText = (document.getElementById("searchInput")?.value || "")
        .toLowerCase()
        .trim();

      const filteredBooks = books.filter(b => {
        const hay = `${b.jpTitle || ""} ${b.enTitle || ""} ${b.title || ""} ${b.series || ""}`.toLowerCase();
        const matchesSearch = hay.includes(searchText);
        const matchesTag = !activeTag || (Array.isArray(b.tags) && b.tags.includes(activeTag));
        return matchesSearch && matchesTag;
      });

      filteredBooks.sort((a, b) => {
        if (a.finished !== b.finished) return Number(a.finished) - Number(b.finished);

        const sa = (a.series || "").trim();
        const sb = (b.series || "").trim();
        if (sa !== sb) return sa.localeCompare(sb);

        const va = numericOrNaN(a.volume);
        const vb = numericOrNaN(b.volume);
        if (!Number.isNaN(va) && !Number.isNaN(vb) && va !== vb) return va - vb;

        const vaS = (a.volume || "").trim();
        const vbS = (b.volume || "").trim();
        if (vaS !== vbS) return vaS.localeCompare(vbS);

        const ta = ((a.jpTitle || a.title || "")).localeCompare((b.jpTitle || b.title || ""));
        if (ta !== 0) return ta;

        return ((a.enTitle || "")).localeCompare((b.enTitle || ""));
      });

      for (const book of filteredBooks) {
        const index = books.indexOf(book);

        const flipCard = document.createElement("div");
        flipCard.className = "flip-card";

        const inner = document.createElement("div");
        inner.className = "flip-inner";

        const front = document.createElement("div");
        front.className = "flip-side book-surface";

        const back = document.createElement("div");
        back.className = "flip-side flip-back book-surface";

        if (book.finished) {
          front.classList.add("finished");
          back.classList.add("finished");
        }

        flipCard.onclick = () => {
          flipCard.classList.toggle("flipped");
          trackEvent("flip_card", {
            jp_title: (book.jpTitle || book.title || ""),
            has_en_title: !!(book.enTitle || "").trim()
          });
        };

        const buildSide = async ({ side, surface }) => {
          const isJP = side === "jp";
          const key = coverKey(book.id, side);

          // cover
          const img = document.createElement("img");
          img.className = "cover";
          img.alt = "cover";
          surface.appendChild(img);

          revokeCoverUrl(key);
          try {
            const blob = await getCover(key);
            if (blob) {
              const url = URL.createObjectURL(blob);
              coverUrlCache.set(key, url);
              img.src = url;

              img.style.cursor = "zoom-in";
              img.onclick = (e) => {
                e.stopPropagation();
                openCoverModal({
                  title: sideTitleOf(book, isJP) || (book.jpTitle || book.title || "Cover"),
                  src: img.src
                });
              };
            } else {
              img.removeAttribute("src");
            }
          } catch {
            img.removeAttribute("src");
          }

          const content = document.createElement("div");
          content.className = "content";

          // title
          const titleEl = document.createElement("div");
          titleEl.className = "title";
          titleEl.textContent = sideTitleOf(book, isJP);

          if (!isJP && !sideTitleOf(book, false).trim()) {
            titleEl.textContent = "Add English title‚Ä¶";
            titleEl.style.opacity = "0.55";
            titleEl.style.fontStyle = "italic";
          }

          if (book.finished) titleEl.style.textDecoration = "line-through";

          // series line
          const seriesLine = document.createElement("div");
          seriesLine.className = "seriesline";
          if (book.series && book.series.trim()) {
            seriesLine.textContent = book.volume && book.volume.trim()
              ? `${book.series.trim()} ‚Äî Vol.${book.volume.trim()}`
              : book.series.trim();
          } else {
            seriesLine.style.display = "none";
          }

          // badge
          const sideLabel = document.createElement("div");
          sideLabel.className = "side-badge";
          sideLabel.textContent = isJP ? "Japanese" : "English";

          // tags
          const tagsEl = document.createElement("div");
          tagsEl.className = "tags";

          (book.tags || []).forEach(tag => {
            const tagEl = document.createElement("span");
            tagEl.className = "tag" + (tag === activeTag ? " active" : "");
            tagEl.textContent = tag;

            tagEl.onclick = (e) => {
              e.stopPropagation();
              activeTag = (activeTag === tag) ? null : tag;
              displayBooks();
            };

            tagEl.oncontextmenu = (e) => {
              e.preventDefault();
              e.stopPropagation();
              book.tags = (book.tags || []).filter(t => t !== tag);
              if (activeTag === tag) activeTag = null;
              saveBooks();
              displayBooks();
            };

            tagsEl.appendChild(tagEl);
          });

          // note
          const noteEl = document.createElement("div");
          noteEl.className = "note";
          const noteValue = isJP ? (book.jpNote || "") : (book.trNote || "");
          if (!noteValue) {
            noteEl.classList.add("empty");
            noteEl.textContent = "No notes yet.";
          } else {
            noteEl.textContent = noteValue;
          }

          // finished checkbox
          const finishedCheckbox = document.createElement("input");
          finishedCheckbox.type = "checkbox";
          finishedCheckbox.checked = !!book.finished;
          finishedCheckbox.onchange = (e) => {
            e.stopPropagation();
            book.finished = finishedCheckbox.checked;
            saveBooks();
            displayBooks();
            trackEvent("toggle_finished", { finished: book.finished, jp_title: (book.jpTitle || book.title || "") });
          };

          const controls = document.createElement("div");
          controls.className = "controls";
          controls.onclick = (e) => e.stopPropagation();
          controls.appendChild(sideLabel);
          controls.appendChild(createCheckSet(finishedCheckbox, "Finished"));

          // buttons row
          const miniRow = document.createElement("div");
          miniRow.className = "mini-row";
          miniRow.onclick = (e) => e.stopPropagation();

          const editTitleButton = document.createElement("button");
          editTitleButton.textContent = "Edit Title";
          editTitleButton.onclick = (e) => {
            e.stopPropagation();

            const current = sideTitleOf(book, isJP);
            openEditModal({
              title: "Edit Title",
              label: isJP ? "Japanese Title" : "English Title",
              value: current,
              multiline: false,
              placeholder: isJP ? "e.g., Êó•Êú¨Ë™û„ÅÆ„Çø„Ç§„Éà„É´" : "e.g., English title",
              onSave: (v) => {
                if (isJP) book.jpTitle = v;
                else book.enTitle = v;

                // legacy compatibility
                book.title = book.jpTitle || book.title || "";

                saveBooks();
                displayBooks();
                trackEvent("edit_title", { side: isJP ? "jp" : "en" });
              }
            });
          };

          const editNoteButton = document.createElement("button");
          editNoteButton.textContent = "Edit Note";
          editNoteButton.onclick = (e) => {
            e.stopPropagation();

            const currentNote = isJP ? (book.jpNote || "") : (book.trNote || "");
            openEditModal({
              title: "Edit Note",
              label: isJP ? "Japanese Note" : "English Note",
              value: currentNote,
              multiline: true,
              placeholder: "Write your notes here‚Ä¶",
              onSave: (v) => {
                if (isJP) book.jpNote = v;
                else book.trNote = v;

                saveBooks();
                displayBooks();
                trackEvent("edit_note", { side: isJP ? "jp" : "en" });
              }
            });
          };

          const removeButton = document.createElement("button");
          removeButton.textContent = "Remove";
          removeButton.onclick = async (e) => {
            e.stopPropagation();

            try { await deleteCover(coverKey(book.id, "jp")); } catch {}
            try { await deleteCover(coverKey(book.id, "tr")); } catch {}
            revokeCoverUrl(coverKey(book.id, "jp"));
            revokeCoverUrl(coverKey(book.id, "tr"));

            books.splice(index, 1);
            saveBooks();
            displayBooks();
            trackEvent("remove_book", { jp_title: (book.jpTitle || book.title || "") });
          };

          const urlButton = document.createElement("button");
          const urlValue = isJP ? (book.jpUrl || "") : (book.trUrl || "");
          urlButton.textContent = urlValue ? "Open URL" : "Set URL";
          urlButton.onclick = (e) => {
            e.stopPropagation();
            if (!urlValue) {
              openEditModal({
                title: "Set URL",
                label: isJP ? "Japanese URL" : "English URL",
                value: "",
                multiline: false,
                placeholder: "https:// ...",
                onSave: (v) => {
                  if (!v) return;
                  if (isJP) book.jpUrl = v;
                  else book.trUrl = v;
                  saveBooks();
                  displayBooks();
                  trackEvent("set_url", { side: isJP ? "jp" : "en" });
                }
              });
            } else {
              window.open(urlValue, "_blank");
              trackEvent("open_url", { side: isJP ? "jp" : "en" });
            }
          };

          const coverButton = document.createElement("button");
          coverButton.textContent = "Set Cover";
          coverButton.onclick = (e) => {
            e.stopPropagation();
            const fileInput = document.getElementById("coverFileInput");
            fileInput.onchange = async () => {
              const file = fileInput.files?.[0];
              if (!file) return;

              try {
                await putCover(key, file);
                revokeCoverUrl(key);
                displayBooks();
                trackEvent("set_cover", { side: isJP ? "jp" : "en" });
              } catch {
                alert("Ë°®Á¥ô„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàIndexedDB„Ç®„É©„ÉºÔºâ„ÄÇ");
              } finally {
                fileInput.value = "";
              }
            };
            fileInput.click();
          };

          const clearCoverButton = document.createElement("button");
          clearCoverButton.textContent = "Clear Cover";
          clearCoverButton.onclick = async (e) => {
            e.stopPropagation();
            try {
              await deleteCover(key);
              revokeCoverUrl(key);
              displayBooks();
              trackEvent("clear_cover", { side: isJP ? "jp" : "en" });
            } catch {
              alert("Ë°®Á¥ô„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
          };

          const tagButton = document.createElement("button");
          tagButton.textContent = "Add Tag";
          tagButton.onclick = (e) => {
            e.stopPropagation();
            openEditModal({
              title: "Add Tag",
              label: "Tag name",
              value: "",
              multiline: false,
              placeholder: "e.g., JLPT N2 / Romance / Mystery",
              onSave: (v) => {
                const clean = (v || "").trim();
                if (!clean) return;
                if (!Array.isArray(book.tags)) book.tags = [];
                if (!book.tags.includes(clean)) {
                  book.tags.push(clean);
                  saveBooks();
                  displayBooks();
                  trackEvent("add_tag", { tag: clean });
                }
              }
            });
          };

          const seriesButton = document.createElement("button");
          seriesButton.textContent = book.series ? "Edit Series" : "Set Series";
          seriesButton.onclick = (e) => {
            e.stopPropagation();

            // series name
            openEditModal({
              title: "Series",
              label: "Series name (optional)",
              value: book.series || "",
              multiline: false,
              placeholder: "e.g., „Äá„Äá„Ç∑„É™„Éº„Ç∫",
              onSave: (seriesName) => {
                // volume
                openEditModal({
                  title: "Volume",
                  label: "Volume number (optional)",
                  value: book.volume || "",
                  multiline: false,
                  placeholder: "e.g., 3",
                  onSave: (vol) => {
                    book.series = (seriesName || "").trim();
                    book.volume = (vol || "").trim();
                    saveBooks();
                    displayBooks();
                    trackEvent("set_series", { series: book.series });
                  }
                });
              }
            });
          };

          miniRow.appendChild(editTitleButton);
          miniRow.appendChild(editNoteButton);
          miniRow.appendChild(removeButton);
          miniRow.appendChild(urlButton);
          miniRow.appendChild(coverButton);
          miniRow.appendChild(clearCoverButton);
          miniRow.appendChild(tagButton);
          miniRow.appendChild(seriesButton);

          content.appendChild(titleEl);
          content.appendChild(seriesLine);
          content.appendChild(tagsEl);
          content.appendChild(controls);
          content.appendChild(noteEl);
          content.appendChild(miniRow);

          surface.appendChild(content);
        };

        await buildSide({ side: "jp", surface: front });
        await buildSide({ side: "tr", surface: back });

        inner.appendChild(front);
        inner.appendChild(back);
        flipCard.appendChild(inner);
        list.appendChild(flipCard);
      }
    }

    // ---- Init ----
    (async function init() {
      ensureBookIdsAndDefaults();
      try {
        await openDB();
      } catch (e) {
        alert("IndexedDB„Åå‰Ωø„Åà„Å™„ÅÑÁí∞Â¢É„Åß„Åô„ÄÇË°®Á¥ô„ÅÆ‰øùÂ≠ò„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
      }
      displayBooks();
    })();

    window.addEventListener("beforeunload", () => {
      for (const [key] of coverUrlCache) revokeCoverUrl(key);
    });
  </script>
</body>
</html>






